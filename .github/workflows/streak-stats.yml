name: Generate Streak Stats

on:
  schedule:
    # Runs at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  update-streak-stats:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Generate Streak Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime, timedelta
          import os
          
          username = "Buddhika-Kuruppu"
          token = os.environ.get('GITHUB_TOKEN')
          
          headers = {'Authorization': f'token {token}'}
          
          # Get contribution data from GitHub GraphQL API
          query = """
          query($userName:String!) {
            user(login: $userName){
              contributionsCollection {
                contributionCalendar {
                  totalContributions
                  weeks {
                    contributionDays {
                      contributionCount
                      date
                    }
                  }
                }
              }
            }
          }
          """
          
          response = requests.post(
              'https://api.github.com/graphql',
              json={'query': query, 'variables': {'userName': username}},
              headers=headers
          )
          
          data = response.json()
          calendar = data['data']['user']['contributionsCollection']['contributionCalendar']
          total_contributions = calendar['totalContributions']
          
          # Calculate streaks and dates
          days = []
          for week in calendar['weeks']:
              for day in week['contributionDays']:
                  days.append({
                      'date': day['date'],
                      'count': day['contributionCount']
                  })
          
          # Find first contribution date
          first_contribution = None
          for day in days:
              if day['count'] > 0:
                  first_contribution = day['date']
                  break
          
          # Current streak with dates
          current_streak = 0
          current_streak_start = None
          current_streak_end = None
          for day in reversed(days):
              if day['count'] > 0:
                  if current_streak == 0:
                      current_streak_end = day['date']
                  current_streak += 1
                  current_streak_start = day['date']
              else:
                  break
          
          # Longest streak with dates
          longest_streak = 0
          longest_streak_start = None
          longest_streak_end = None
          temp_streak = 0
          temp_start = None
          for day in days:
              if day['count'] > 0:
                  if temp_streak == 0:
                      temp_start = day['date']
                  temp_streak += 1
                  if temp_streak > longest_streak:
                      longest_streak = temp_streak
                      longest_streak_start = temp_start
                      longest_streak_end = day['date']
              else:
                  temp_streak = 0
          
          # Format dates
          from datetime import datetime
          def format_date(date_str):
              if not date_str:
                  return ""
              d = datetime.strptime(date_str, '%Y-%m-%d')
              return d.strftime('%b %d, %Y')
          
          first_contrib_formatted = format_date(first_contribution) if first_contribution else "Present"
          current_start_formatted = format_date(current_streak_start) if current_streak_start else ""
          current_end_formatted = format_date(current_streak_end) if current_streak_end else ""
          longest_start_formatted = format_date(longest_streak_start) if longest_streak_start else ""
          longest_end_formatted = format_date(longest_streak_end) if longest_streak_end else ""
          
          # Create SVG matching demolab.com high contrast theme
          svg = f'''<svg width="495" height="195" viewBox="0 0 495 195" fill="none" xmlns="http://www.w3.org/2000/svg">
            <style>
              .stat-label {{ font: 600 14px 'Segoe UI', Ubuntu, Sans-Serif; fill: #ffffff }}
              .stat-value {{ font: 800 28px 'Segoe UI', Ubuntu, Sans-Serif; fill: #ffffff }}
              .date-range {{ font: 400 12px 'Segoe UI', Ubuntu, Sans-Serif; fill: #9f9f9f }}
              .ring {{ fill: none; stroke: #fb8c00; stroke-width: 6; stroke-linecap: round }}
              .current-label {{ font: 700 14px 'Segoe UI', Ubuntu, Sans-Serif; fill: #fb8c00 }}
              .separator {{ stroke: #444c56; stroke-width: 2 }}
            </style>
            <rect width="495" height="195" rx="4.5" fill="#000000" stroke="#444c56" stroke-width="1"/>
            
            <!-- Vertical Separators -->
            <line x1="165" y1="30" x2="165" y2="165" class="separator"/>
            <line x1="330" y1="30" x2="330" y2="165" class="separator"/>
            
            <!-- Total Contributions -->
            <g transform="translate(82.5, 80)">
              <text x="0" y="0" text-anchor="middle" class="stat-value">{total_contributions}</text>
              <text x="0" y="25" text-anchor="middle" class="stat-label">Total Contributions</text>
              <text x="0" y="50" text-anchor="middle" class="date-range">{first_contrib_formatted} - Present</text>
            </g>
            
            <!-- Current Streak -->
            <g transform="translate(247.5, 80)">
              <circle class="ring" cx="0" cy="0" r="40"/>
              <text x="0" y="10" text-anchor="middle" class="stat-value">{current_streak}</text>
              <text x="0" y="60" text-anchor="middle" class="current-label">Current Streak</text>
              <text x="0" y="80" text-anchor="middle" class="date-range">{current_start_formatted} - {current_end_formatted}</text>
            </g>
            
            <!-- Longest Streak -->
            <g transform="translate(412.5, 80)">
              <text x="0" y="0" text-anchor="middle" class="stat-value">{longest_streak}</text>
              <text x="0" y="25" text-anchor="middle" class="stat-label">Longest Streak</text>
              <text x="0" y="50" text-anchor="middle" class="date-range">{longest_start_formatted} - {longest_end_formatted}</text>
            </g>
          </svg>'''
          
          # Save SVG
          with open('streak-stats.svg', 'w') as f:
              f.write(svg)
          
          print(f"Generated streak stats: Total={total_contributions}, Current={current_streak}, Longest={longest_streak}")
          EOF
          
      - name: Move to output directory
        run: |
          mkdir -p output
          mv streak-stats.svg output/
          
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add output/streak-stats.svg
          git diff --staged --quiet || git commit -m "Update streak stats [skip ci]"
          git push
